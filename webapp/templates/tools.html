	{% extends "page-skeleton.html" %}

{% block head %}
	{{ super() }}
	<script>
		let originalTitle, originalButtonText;
		$(document).ready(() => {
			originalTitle = document.querySelector("#database-form-title").innerText;
			originalButtonText = document.querySelector("#database-form-button-text").innerText;
			originalAction = document.querySelector("#database-change-form form").action;
		})

		// switches between the create database and delete database forms. If the database name db
		// is specified, then it will pick the delete database form. Otherwise, it will pick the
		// create database form.
		function databaseForm(db) {
			const formTitle = document.querySelector("#database-form-title");
			const formButton = document.querySelector("#database-form-button-text");
			const form = document.querySelector("#database-change-form form");
			const dbnameInput = document.querySelector("#dbname");
			if (db) {
				form.action = "/deletedb";
				console.log(form.action);
				formTitle.innerText = "Delete Database:";
				formButton.innerText = "Remove";
				dbnameInput.value = db;
				Materialize.updateTextFields();
			} else {
				form.action = originalAction;
				formTitle.innerText = originalTitle;
				formButton.innerText = originalButtonText;
				dbnameInput.value = "";
				Materialize.updateTextFields();
			}
		}

		// replaces the database changing form. If resetCard is true, then it changes it back
		function passwordReset(resetCard) {
			const formChange = document.querySelector("#database-change-form");
			const formReset = document.querySelector("#password-reset-form");
			if (!resetCard) {
				formReset.style.display = "block";
				formChange.style.display = "none";
			} else {
				formReset.style.display = "none";
				formChange.style.display = "block";
			}
		}
	</script>
	<style>
		li a.logout-button {
			display: inline-block;
		}
	</style>
{% endblock %}

{% block body %}
	{{ super() }}
	{# these are the tab headers just under the navbar. Each header must have a corresponding
	div.col.s12 below #}
	<div class="col s12">
		<ul class="tabs z-depth-1">
			<div class="indicator teal lighten-2" style="z-index:1">{# this changes the tab colors #}</div>
			<li class="tab">
				<a class="{% if mysql_active %} active {% endif %}teal-text lighten-2" href="#mysql">MySQL</a>
			</li>
			<li class="tab">
				<a class="{% if backup_active %} active {% endif %}teal-text lighten-2" href="#backups">Backups</a>
			</li>
			<li class="tab">
				<a class="{% if wordpress_active %} active {% endif %}teal-text lighten-2" href="#wordpress">Wordpress</a>
			</li>
			<li class="tab">
				<a class="{% if help_active %} active {% endif %}teal-text lighten-2" href="#help">Help</a>
			</li>
		</ul>
	</div>

	{# This stuff is the MySQL tab #}
	<div id="mysql" class="col s12">
		<div class="card z-depth-3" style="min-height: 400px;width:60%;margin-left:auto;margin-right:auto;margin-top:2%;padding-bottom: 3%;">
			<div class="card-content">
				<span class="card-title">MySQL Databases</span>
				{% if databases|length > 0 %}
					<ul class="collection">
						{% for db in databases %}
							<li class="collection-item">
								<div>
									{{ db }}
									<div onclick="databaseForm('{{ db }}')" class="activator secondary-content">
										<i class="material-icons">delete</i>
									</div>
								</div>
							</li>
						{% endfor %}
					</ul>
				{% else %}
					<p> No Databases to show &nbsp;&nbsp; O_o </p><br>
				{% endif %}

				<a class="activator left btn waves-effect waves-light" onclick="passwordReset(false)">Reset MySQL Password&nbsp;&nbsp;<i class="material-icons">settings_backup_restore</i></a>
				<a class="activator right btn-floating halfway-fab waves-effect waves-light teal"><i class="material-icons">add</i></a>
				<br><br>
				<span style="display:block;" class="error-msg">{{ mysql_error }}</span>
				{% if new_mysql_password %}
				<p style="color:green;">Your new MySQL password: {{ new_mysql_password }}</p>
				{% endif %}
			</div>

			{# card reveals are what come up when you click something with class "activator".
			The Javascript in the header does the necessary things to pick the correct form
			and change the form as need be. Normally, there is only one "card-reveal" so this
			is a bit of a hack #}
			<div class="card-reveal" style="overflow: hidden;">
				<div id="database-change-form">
					<span class="card-title" onclick="databaseForm('')">
						<span id="database-form-title">New Database:</span>
						<i class="material-icons right">close</i>
					</span>
					<form action="/createdb" method="POST">
						<div class="input-field">
							<input autocomplete="off" id="username" type="text" name="username">
							<label for="username">Server username</label>
						</div>
						<div class="input-field">
							<input autocomplete="off" id="password" type="password" name="password">
							<label for="password">Server password</label>
						</div>
						<div class="input-field">
							<input autocomplete="off" id="dbname" type="text" name="dbname">
							<label for="dbname">Database name</label>
						</div>
						<button class="btn waves-effect waves-light" type="submit">
							<span id="database-form-button-text"> Create </span>
							<i class="mdi-content-send right"></i>
						</button>
					</form>
				</div>
				<div id="password-reset-form" style="display: none;">
					<span class="card-title" onclick="passwordReset(true)">
						<span>Reset MySQL Password:</span>
						<i class="material-icons right">close</i>
					</span>
					<form action="/resetpw" method="POST">
						<div class="input-field" method="POST">
							<input autocomplete="off" id="username" type="text" name="username">
							<label for="username">Server username</label>
						</div>
						<div class="input-field">
							<input autocomplete="off" id="password" type="password" name="password">
							<label for="password">Server password</label>
						</div>
						<button class="btn waves-effect waves-light" type="submit">
							<span id="database-form-button-text"> Reset </span>
							<i class="mdi-content-send right"></i>
						</button>
					</form>
				</div>
			</div>
		</div>
	</div>

	{# This stuff is for the backup tab #}
	<div id="backups" class="col s12">
		<div class="card z-depth-3" style="min-height: 400px;width:60%;margin-left:auto;margin-right:auto;margin-top:2%;padding-bottom: 3%;">
			<div class="card-content">
				<span class="card-title">Home Directory Backups</span>

				{# Tab headers #}
				<div class="col s12">
					<ul class="tabs">
						<li class="col s6 tab"><a class="active teal-text lighten-2" href="#weekly-backups"> Weekly </a></li>
						<li class="col s6 tab"><a class="teal-text lighten-2" href="#monthly-backups"> Monthly </a></li>
						<div class="indicator teal lighten-2" style="z-index:1"></div>
					</ul>
				</div>

				{# Weekly body #}
				<div id="weekly-backups" class="col s12">
					{% if weekly_backups|length > 0 %}
						<ul class="collection" style="max-height: 20em; overflow-y:scroll;">
							{% for b in weekly_backups %}
								<li class="collection-item">
									<div>
										{{ b }}
										<a class="activator secondary-content" href="/backup/{{ username }}/weekly/{{ b }}">
											<i class="material-icons">cloud_download</i>
										</a>
									</div>
								</li>
							{% endfor %}
						</ul>
					{% else %}
						<p> No backups were found. If you have had your account for over a week, please contact us.</p><br>
					{% endif %}
				</div>

				{# Monthly body #}
				<div id="monthly-backups" class="col s12">
					{% if monthly_backups|length > 0 %}
						<ul class="collection" style="max-height: 20em; overflow-y:scroll;">
							{% for b in monthly_backups %}
								<li class="collection-item">
									<div>
										{{ b }}
										<a class="activator secondary-content" href="/backup/{{ username }}/monthly/{{ b }}">
											<i class="material-icons">cloud_download</i>
										</a>
									</div>
								</li>
							{% endfor %}
						</ul>
					{% else %}
						<p> No backups were found. If you have had your account for over a month, please contact us.</p><br>
					{% endif %}
				</div>
			</div>
		</div>
	</div>

	{# This stuff is for the wordpress tab #}
	<div id="wordpress" class="col s12">
		<div class="card z-depth-3" style="min-height: 400px;width:60%;margin-left:auto;margin-right:auto;margin-top:2%;padding-bottom: 3%;">
			<div class="card-content">
				<span class="card-title">Wordpress</span>
				<p> We plan on providing a way for you to install WordPress, no mess, no fuss from this section. This feature is still under development however. We will announce when this becomes available on our FaceBook page. </p>
			</div>
		</div>
	</div>

	{# This tab is for the help section that will relay the message to SysAdmins #}
	<div id="help" class="col s12">
		<div class='card z-depth-3' style='width: 60%;margin-left:auto;margin-right:auto;margin-top:2%;'>
			<div id="help" class="card-content">
				<span class="card-title">Got an issue? Need help?</span>

				{% if help_error %}
					<p class='red-text'>{{ help_error }}</p>
				{% endif %}

				{% if help_success %}
					<p class='teal-text'>Help is on the way!</p>
				{% else %}
					<p class='flow-text'>Fill in the form below and one of the awesome Netsoc SysAdmins will get back to you ASAP!</p>
				{% endif %}
				<form action='/help' method='post'>
					<div class='input-field row'>
						<label for='subject'>Subject</label>
						<input type='text' name='subject' id='subject'>
					</div>
					<div class='input-field row'>
						<label for='email'>Your e-mail</label>
						<input type='text' name='email' id='email'>
					</div>
					<div class='input-field row s12'>
						<label for='body'>Message</label>
						<textarea cols="20" rows="40" class="materialize-textarea" name='message' id='message'></textarea>
					</div>

					<button class="btn waves-effect waves-light" type="submit">
						Send 'er away!
						<i class="mdi-content-send right"></i>
					</button>
				</form>
			</div>
		</div>
	</div>
{% endblock %}
